<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>PROMED Inventory</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px}
    .login-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;z-index:1000}
    .login-box{background:white;padding:40px;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.3);text-align:center;max-width:400px;width:90%}
    .login-box h1{color:#667eea;font-size:32px;margin-bottom:8px}
    .login-box p{color:#666;font-size:14px;margin-bottom:30px}
    .login-box input{width:100%;padding:14px;border:2px solid #e0e0e0;border-radius:8px;font-size:15px;margin-bottom:16px}
    .login-box button{width:100%;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;padding:14px;border-radius:8px;cursor:pointer;font-weight:600;font-size:16px}
    .error{color:#ef4444;font-size:13px;margin-top:10px}
    .app{max-width:1400px;margin:0 auto;display:none}
    .header{background:white;padding:25px;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 6px rgba(0,0,0,0.1);position:relative}
    .header h1{color:#667eea;font-size:28px;margin-bottom:8px}
    .header p{color:#666;font-size:14px}
    .logout{position:absolute;top:25px;right:25px;background:#ef4444;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px}
    .tabs{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
    .tab-btn{background:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;color:#666;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
    .tab-btn.active{background:linear-gradient(135deg,#667eea,#764ba2);color:white}
    .tab-content{display:none;background:white;border-radius:12px;padding:25px;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
    .tab-content.active{display:block}
    .tab-content h2{color:#333;font-size:22px;margin-bottom:8px}
    .tab-content>p{color:#666;font-size:14px;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
    .table-wrap{overflow-x:auto;margin-bottom:20px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    thead{background:linear-gradient(135deg,#667eea,#764ba2);color:white}
    th{padding:12px;text-align:left;font-weight:600;white-space:nowrap}
    td{padding:10px 12px;border-bottom:1px solid #e0e0e0}
    tbody tr:hover{background:#f8f9ff}
    input,select{width:100%;padding:6px 8px;border:1px solid #ddd;border-radius:4px;font-size:13px}
    .computed{background:#f0f9ff;font-weight:600;color:#0284c7}
    .btn{background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;margin-top:10px}
    .btn.green{background:#10b981;margin-left:10px}
    .status{margin-top:15px;padding:12px;border-radius:6px;font-size:14px;font-weight:500;display:none;white-space:pre-wrap}
    .status.success{background:#d1fae5;color:#065f46;border:1px solid #10b981;display:block}
    .status.error{background:#fee2e2;color:#991b1b;border:1px solid #ef4444;display:block}
    .status.loading{background:#dbeafe;color:#1e40af;border:1px solid #3b82f6;display:block}
  </style>
</head>
<body>

<div id="loginScreen" class="login-screen">
  <div class="login-box">
    <h1>üìä PROMED</h1>
    <p>Inventory & Financial Tracker</p>
    <input type="password" id="loginCode" placeholder="Enter access code">
    <button onclick="doLogin()">Login</button>
    <p id="loginError" class="error"></p>
  </div>
</div>

<div id="app" class="app">
  <div class="header">
    <h1>üìä PROMED ‚Äî Inventory Tracker</h1>
    <p>Complete inventory management system</p>
    <button class="logout" onclick="doLogout()">Logout</button>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="showTab(0)">üì¶ Inventory</button>
    <button class="tab-btn" onclick="showTab(1)">üéÅ Bundles</button>
    <button class="tab-btn" onclick="showTab(2)">üí∞ Sales</button>
    <button class="tab-btn" onclick="showTab(3)">üìã Payables</button>
  </div>

  <div id="tab0" class="tab-content active">
    <h2>üì¶ Aggregated Inventory</h2>
    <p>Current inventory state</p>
    <div class="table-wrap">
      <table id="invTable">
        <thead><tr><th>Item</th><th>Category</th><th>Qty</th><th>Cost (‚Çµ)</th><th>Price (‚Çµ)</th><th>Total Cost</th><th>Total Retail</th><th>Notes</th></tr></thead>
        <tbody id="invBody">
          <tr>
            <td><input type="text" placeholder="e.g. Stethoscope"></td>
            <td><input type="text" placeholder="e.g. Cardio"></td>
            <td><input type="number" class="qty" min="0" placeholder="0"></td>
            <td><input type="number" class="cost" min="0" step="0.01" placeholder="0.00"></td>
            <td><input type="number" class="price" min="0" step="0.01" placeholder="0.00"></td>
            <td class="computed tc">0.00</td>
            <td class="computed tr">0.00</td>
            <td><input type="text" placeholder="notes"></td>
          </tr>
        </tbody>
      </table>
    </div>
    <button class="btn" onclick="addRow('invBody','inv')">+ Add</button>
    <button class="btn green" onclick="submitSheet('Aggregated Inventory','invTable','invStatus')">üì§ Submit</button>
    <div id="invStatus" class="status"></div>
  </div>

  <div id="tab1" class="tab-content">
    <h2>üéÅ Bundles</h2>
    <p>Bundle pricing and contents</p>
    <div class="table-wrap">
      <table id="bunTable">
        <thead><tr><th>Bundle</th><th>Price (‚Çµ)</th><th>Item 1</th><th>Qty 1</th><th>Item 2</th><th>Qty 2</th><th>Item 3</th><th>Qty 3</th><th>Notes</th></tr></thead>
        <tbody id="bunBody">
          <tr>
            <td><input type="text" placeholder="e.g. Basic Kit"></td>
            <td><input type="number" min="0" step="0.01" placeholder="0.00"></td>
            <td><input type="text"></td><td><input type="number" min="0" placeholder="0"></td>
            <td><input type="text"></td><td><input type="number" min="0" placeholder="0"></td>
            <td><input type="text"></td><td><input type="number" min="0" placeholder="0"></td>
            <td><input type="text"></td>
          </tr>
        </tbody>
      </table>
    </div>
    <button class="btn" onclick="addRow('bunBody','bun')">+ Add</button>
    <button class="btn green" onclick="submitSheet('Bundles Packages','bunTable','bunStatus')">üì§ Submit</button>
    <div id="bunStatus" class="status"></div>
  </div>

  <div id="tab2" class="tab-content">
    <h2>üí∞ Sales</h2>
    <p>Recent sales data</p>
    <div class="table-wrap">
      <table id="salesTable">
        <thead><tr><th>Date</th><th>Item</th><th>Type</th><th>Qty</th><th>Price (‚Çµ)</th><th>Payment</th><th>Notes</th></tr></thead>
        <tbody id="salesBody">
          <tr>
            <td><input type="date"></td>
            <td><input type="text"></td>
            <td><select><option>Single</option><option>Bundle</option></select></td>
            <td><input type="number" min="0" placeholder="0"></td>
            <td><input type="number" min="0" step="0.01" placeholder="0.00"></td>
            <td><select><option>Cash</option><option>MoMo</option><option>Transfer</option></select></td>
            <td><input type="text"></td>
          </tr>
        </tbody>
      </table>
    </div>
    <button class="btn" onclick="addRow('salesBody','sales')">+ Add</button>
    <button class="btn green" onclick="submitSheet('Sales Snapshot','salesTable','salesStatus')">üì§ Submit</button>
    <div id="salesStatus" class="status"></div>
  </div>

  <div id="tab3" class="tab-content">
    <h2>üìã Payables</h2>
    <p>Outstanding debts</p>
    <div class="table-wrap">
      <table id="payTable">
        <thead><tr><th>Creditor</th><th>Amount (‚Çµ)</th><th>Reason</th><th>Items</th><th>Due</th><th>Status</th><th>Notes</th></tr></thead>
        <tbody id="payBody">
          <tr>
            <td><input type="text"></td>
            <td><input type="number" min="0" step="0.01" placeholder="0.00"></td>
            <td><input type="text"></td>
            <td><input type="text"></td>
            <td><input type="date"></td>
            <td><select><option>Pending</option><option>Paid</option><option>Overdue</option></select></td>
            <td><input type="text"></td>
          </tr>
        </tbody>
      </table>
    </div>
    <button class="btn" onclick="addRow('payBody','pay')">+ Add</button>
    <button class="btn green" onclick="submitSheet('Payables Debts','payTable','payStatus')">üì§ Submit</button>
    <div id="payStatus" class="status"></div>
  </div>
</div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzkp7ALMIHOLn63TZICf4gYaaoMc67D14sYpgKwkE3hxbN5-SsJbSbn4DsRm_9_ly-IcQ/exec";

  function doLogin(){
    const c = document.getElementById('loginCode').value;
    if(c === 'promedLogin'){
      document.getElementById('loginScreen').style.display='none';
      document.getElementById('app').style.display='block';
      document.getElementById('loginError').textContent='';
    } else {
      document.getElementById('loginError').textContent='Incorrect code';
    }
  }

  function doLogout(){
    if(confirm('Logout?')){
      document.getElementById('loginScreen').style.display='flex';
      document.getElementById('app').style.display='none';
      document.getElementById('loginCode').value='';
    }
  }

  document.getElementById('loginCode').addEventListener('keypress', e => {
    if(e.key === 'Enter') doLogin();
  });

  function showTab(i){
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-content')[i].classList.add('active');
    document.querySelectorAll('.tab-btn')[i].classList.add('active');
  }

  // Auto compute totals for inventory
  document.getElementById('invBody').addEventListener('input', e => {
    if(e.target.classList.contains('qty') || e.target.classList.contains('cost') || e.target.classList.contains('price')){
      const r = e.target.closest('tr');
      const q = parseFloat(r.querySelector('.qty').value) || 0;
      const c = parseFloat(r.querySelector('.cost').value) || 0;
      const p = parseFloat(r.querySelector('.price').value) || 0;
      r.querySelector('.tc').textContent = (q*c).toFixed(2);
      r.querySelector('.tr').textContent = (q*p).toFixed(2);
    }
  });

  function addRow(id,type){
    const b=document.getElementById(id);
    if(type==='inv'){
      b.insertAdjacentHTML('beforeend',
        `<tr>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="number" class="qty" min="0"></td>
          <td><input type="number" class="cost" min="0" step="0.01"></td>
          <td><input type="number" class="price" min="0" step="0.01"></td>
          <td class="computed tc">0.00</td>
          <td class="computed tr">0.00</td>
          <td><input type="text"></td>
        </tr>`
      );
    } else if(type==='bun'){
      b.insertAdjacentHTML('beforeend',
        `<tr>
          <td><input type="text"></td>
          <td><input type="number" min="0" step="0.01"></td>
          <td><input type="text"></td><td><input type="number" min="0"></td>
          <td><input type="text"></td><td><input type="number" min="0"></td>
          <td><input type="text"></td><td><input type="number" min="0"></td>
          <td><input type="text"></td>
        </tr>`
      );
    } else if(type==='sales'){
      b.insertAdjacentHTML('beforeend',
        `<tr>
          <td><input type="date"></td>
          <td><input type="text"></td>
          <td><select><option>Single</option><option>Bundle</option></select></td>
          <td><input type="number" min="0"></td>
          <td><input type="number" min="0" step="0.01"></td>
          <td><select><option>Cash</option><option>MoMo</option><option>Transfer</option></select></td>
          <td><input type="text"></td>
        </tr>`
      );
    } else if(type==='pay'){
      b.insertAdjacentHTML('beforeend',
        `<tr>
          <td><input type="text"></td>
          <td><input type="number" min="0" step="0.01"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="date"></td>
          <td><select><option>Pending</option><option>Paid</option><option>Overdue</option></select></td>
          <td><input type="text"></td>
        </tr>`
      );
    }
  }

  // ‚úÖ Reliable submit: open a new tab that runs fetch (no CORS because it‚Äôs a top-level page)
  function submitSheet(sheetName, tableId, statusId){
    const st=document.getElementById(statusId);
    st.className='status loading';
    st.textContent='üì§ Preparing submission...';

    const rows = collectRows(tableId);
    if(rows.length === 0){
      st.className='status error';
      st.textContent='‚ö†Ô∏è No data to submit.';
      setTimeout(()=>st.style.display='none', 4000);
      return;
    }

    // Create a lightweight submission page in a new tab that can use fetch
    const payload = { sheetName, rows };

    const html = `<!doctype html>
      <html><head><meta charset="utf-8"><title>Submitting‚Ä¶</title></head>
      <body style="font-family:Arial;padding:18px">
        <h3>Submitting ${rows.length} row(s) to "${sheetName}"‚Ä¶</h3>
        <pre id="log" style="background:#f5f5f5;padding:12px;border-radius:8px;white-space:pre-wrap"></pre>
        <script>
          const SCRIPT_URL = ${JSON.stringify(SCRIPT_URL)};
          const payload = ${JSON.stringify(payload)};
          const log = (m) => document.getElementById('log').textContent += m + "\\n";

          async function run(){
            let ok=0, fail=0;
            for(let i=0;i<payload.rows.length;i++){
              const row = payload.rows[i];
              try{
                const res = await fetch(SCRIPT_URL, {
                  method: "POST",
                  headers: {"Content-Type":"application/json"},
                  body: JSON.stringify({sheetName: payload.sheetName, row})
                });
                const txt = await res.text();
                log("Row " + (i+1) + ": " + txt);
                if(res.ok) ok++; else fail++;
              } catch(e){
                fail++;
                log("Row " + (i+1) + " ERROR: " + e);
              }
              await new Promise(r=>setTimeout(r, 250));
            }
            log("\\nDone. Success=" + ok + " Failed=" + fail);
          }
          run();
        <\/script>
      </body></html>`;

    const blob = new Blob([html], {type:'text/html'});
    const blobUrl = window.URL.createObjectURL(blob);
    const w = window.open(blobUrl, '_blank');

    if(!w){
      st.className='status error';
      st.textContent='‚ùå Popup blocked. Allow popups and try again.';
      setTimeout(()=>st.style.display='none', 6000);
      window.URL.revokeObjectURL(blobUrl);
      return;
    }

    st.className='status success';
    st.textContent='‚úÖ Opened submission tab. It will show success/errors per row.';
    setTimeout(()=>{ st.style.display='none'; window.URL.revokeObjectURL(blobUrl); }, 6000);
  }

  function collectRows(tableId){
    const rows=[];
    document.getElementById(tableId).querySelectorAll('tbody tr').forEach(tr=>{
      const tds = Array.from(tr.querySelectorAll('td'));
      const row = tds.map(td=>{
        const el = td.querySelector('input,select');
        return el ? el.value : td.textContent;
      });

      // Only include if any input has meaningful content
      const inputs = Array.from(tr.querySelectorAll('input,select')).map(x => (x.value ?? '').trim());
      const meaningful = inputs.some(v => v !== '' && v !== '0' && v !== '0.00');

      if(meaningful) rows.push(row);
    });
    return rows;
  }
</script>
</body>
</html>
